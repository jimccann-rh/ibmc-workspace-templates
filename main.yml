---

- name: create schematics workspace
  hosts: localhost
  gather_facts: true
  collections:
    - community.general

  tags:
    - bms

#  vars:
#    workspace_bms_name: "ci-bms-single-esxi"
#    repo_bms: "https://github.com/jimccann-rh/ibmc-workspace-bms-single-quote.git"

  vars:
    json_data: "{{ lookup('file','data.json') | from_json }}"

  tasks:

    - name: Run ibmcloud cli
      shell: "ibmcloud schematics workspace list -j > data.json"
      register: ibmcli_output
      failed_when: ( ibmcli_output.rc not in [ 0, 1 ] )

    - name: Include vars 
      ansible.builtin.include_vars:
        file: workspace_settings.yml
        name: ws

    - name: data
      debug:
        msg: "{{ item.name }}"
      loop: "{{ json_data.workspaces }}"


    - block:

       - name: set fact
         set_fact:
           twingatelookup: "{{ json_data.workspaces | selectattr(ws.name_workspace_twingate_name) |list }}" 

       - name: data
         debug:
           msg: "{{ twingatelookup }}"

#       - name: Create templates for twingate
#         include_tasks: twingate.yml
#      when: twingatelookup | bool

#    - block:
#
#       - name: Create templates for BMS esxi
#         include_tasks: bms.yml
#         loop: "{{ range( ws.name_bms_start, ws.name_bms_count + 1 )|list }}"
#         loop_control:
#           loop_var: loop_bms
#           index_var: my_idx
#
